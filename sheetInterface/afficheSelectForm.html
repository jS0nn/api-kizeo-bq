<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
      .existing-table-modal .modal-dialog {
        max-width: 520px;
      }

      .existing-table-modal .modal-title,
      .existing-table-modal .modal-table-label {
        font-size: 1rem;
        font-weight: 600;
        line-height: 1.4;
        margin-bottom: 0;
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      .existing-table-modal .modal-table-meta {
        font-size: 0.85rem;
        color: #5f6368;
        word-break: break-word;
        overflow-wrap: anywhere;
      }

      .existing-table-modal .modal-body ul {
        padding-left: 1.2rem;
        margin-bottom: 0;
      }

      .existing-table-modal .modal-body li + li {
        margin-top: 0.25rem;
      }
    </style>

    <title>KIZEOFORM</title>
  </head>
  <body>

    <div class="container mt-3">

      <h1 class="mt-3 shadow p-3 mb-5 bg-white rounded text-center text-primary">Selectionner un formulaire : </h1>
     <div class="d-none" id="divForm">
        <label for="selectForm" class="form-label">Formulaires :</label>
        <div class="form-text">Choisir le formulaire à traiter</div>
        <div class="input-group">
            <div class="input-field">
                <select type="text" class="select2Class" id="selectForm" name="selectForm" required>  
                </select>
            </div>
        </div>
       <br>
        <form id="formulaireVariables"> 
          <div id="divCheckboxes"></div>
          <div class="mb-3">
            <label for="bqTableName" class="form-label">Nom de table BigQuery</label>
            <input type="text" class="form-control" id="bqTableName" name="bqTableName" maxlength="128" placeholder="exemple : inspection_chantier">
            <div class="form-text">La saisie du nom est optionnelle : laisser vide pour que l'identifiant et le nom du formulaire soient utilisés automatiquement. Renseignez-le uniquement si vous souhaitez personnaliser la partie alias.</div>
          </div>
          <div class="d-flex justify-content-center mb-4">
            <button type="submit" id="boutonEnvoiFormulaireVariables">Ajouter à la configuration</button>                
          </div>  
        </form>  
      </div>
      

      <div class="d-flex justify-content-center mt-5">
        <div class="d-none" role="status" id="chargement">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>

    <div class="modal fade existing-table-modal" id="bqTableExistsModal" tabindex="-1" aria-hidden="true" aria-labelledby="bqExistingTableLabel">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
          <div class="modal-header border-0 pb-0">
            <div>
              <p class="text-muted text-uppercase small mb-1">Table déjà provisionnée</p>
              <h5 class="modal-title modal-table-label" id="bqExistingTableLabel"></h5>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
          </div>
          <div class="modal-body">
            <p class="modal-table-meta mb-3" id="bqExistingTableDataset"></p>
            <div class="alert alert-warning" role="alert">
              <p class="fw-bold mb-2">Cette table existe déjà dans BigQuery.</p>
              <ul class="mb-0 ps-3">
                <li>Une nouvelle action sera créée pour ce formulaire.</li>
                <li>La configuration précédente sera remplacée et la table existante sera effacée.</li>
                <li>Risque de doublon si un autre classeur utilise encore cette table.</li>
              </ul>
            </div>
            <p class="small mb-0 text-muted">Confirmez uniquement si vous souhaitez réutiliser cette table malgré ces impacts.</p>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-outline-secondary" id="bqExistingTableCancel" data-bs-dismiss="modal">Annuler</button>
            <button type="button" class="btn btn-primary" id="bqExistingTableConfirm">Réutiliser cette table</button>
          </div>
        </div>
      </div>
    </div>
    

    <!-- Optional JavaScript-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function(event) { 
        //équivalent du document ready jquery
        document.getElementById("chargement").className = "spinner-border text-primary";
        
        google.script.run.withSuccessHandler(creeListeForm).chargelisteFormulaires();
      });


      const selectForm = document.getElementById('selectForm');
      const tableNameInput = document.getElementById('bqTableName');
      const submitButton = document.getElementById('boutonEnvoiFormulaireVariables');
      const existingTableModalEl = document.getElementById('bqTableExistsModal');
      const existingTableLabel = document.getElementById('bqExistingTableLabel');
      const existingTableDataset = document.getElementById('bqExistingTableDataset');
      const existingTableConfirmBtn = document.getElementById('bqExistingTableConfirm');
      const existingTableCancelBtn = document.getElementById('bqExistingTableCancel');
      const BootstrapModal = typeof bootstrap !== 'undefined' && bootstrap && typeof bootstrap.Modal === 'function'
        ? bootstrap.Modal
        : null;
      const existingTableModalInstance = existingTableModalEl && BootstrapModal
        ? new BootstrapModal(existingTableModalEl, { backdrop: 'static', keyboard: false })
        : null;
      let pendingTableModalResolver = null;
      const MAX_TABLE_NAME_LENGTH = 128;
      const BQ_TABLE_PART_SEPARATOR = '__';

      selectForm.addEventListener('change', function() {
        const index = selectForm.selectedIndex;
        document.getElementById("boutonEnvoiFormulaireVariables").className = "btn btn-primary btn-lg";
        if (index > 0) {
          const formName = selectForm.options[index].text;
          const formId = selectForm.options[index].value;
          const defaultTableName = buildDefaultTableName(formId, formName);
          tableNameInput.value = defaultTableName;
          tableNameInput.dataset.defaultTableName = defaultTableName;
        } else {
          tableNameInput.value = '';
          delete tableNameInput.dataset.defaultTableName;
        }
        tableNameInput.classList.remove('is-invalid');
      });

      tableNameInput.addEventListener('input', function() {
        tableNameInput.classList.remove('is-invalid');
      });

      function creeListeForm(listeForm) {
        var sel = document.getElementById("selectForm");
        var opt = document.createElement("option");
        opt.value = "";
        opt.text = "Formulaires";
        sel.add(opt, null);  //ajoute l'option à la fin du select

        for(let i=0; i<listeForm.length; i++){
          var opt = document.createElement("option");
          opt.value = listeForm[i].id;
          opt.text = listeForm[i].name;
          sel.add(opt, null);  //ajoute l'option à la fin du select
        }
        
        document.getElementById("selectForm").options[0].disabled = true;
        document.getElementById("chargement").className = "d-none";
        document.getElementById("divForm").className = "d-block shadow-sm p-3 mb-5 bg-white";
        $('.select2Class').select2();
      }

      // Gestion du formulaire avec preventDefault pour éviter les soumissions multiples
      document.getElementById("formulaireVariables").addEventListener("submit", function(event) {
        event.preventDefault(); // Empêche la soumission standard du formulaire
        handleFormSubmitVar();
      });

      //Envoie les données dans le GS pour stockage en Sheet
      function handleFormSubmitVar() {
        const formulaire = selectForm.options[selectForm.selectedIndex].text;
        const formulaireID = selectForm.options[selectForm.selectedIndex].value;

        const defaultTableName = buildDefaultTableName(formulaireID, formulaire);
        const finalTableName = normalizeTableName(formulaireID, formulaire, tableNameInput.value || defaultTableName);

        const hasTooLongName = finalTableName.length > MAX_TABLE_NAME_LENGTH;
        if (!finalTableName || hasTooLongName) {
          tableNameInput.classList.add('is-invalid');
          tableNameInput.focus();
          if (hasTooLongName) {
            alert(`Le nom de table BigQuery doit contenir ${MAX_TABLE_NAME_LENGTH} caractères maximum.`);
          }
          return;
        }

        tableNameInput.value = finalTableName;
        tableNameInput.classList.remove('is-invalid');

        // Désactiver le bouton pour éviter les clics multiples
        submitButton.disabled = true;

        const aliasPart = extractAliasPart(formulaireID, finalTableName);
        var formulaireObj = {id: formulaireID, nom: formulaire, tableName: finalTableName, alias: aliasPart};
        verifyBigQueryTableBeforeSave(formulaireObj);
      }

      function verifyBigQueryTableBeforeSave(formulaireObj) {
        google.script.run
          .withSuccessHandler(function(status) {
            evaluateTableStatus(status)
              .then(function(decision) {
                if (!decision || !decision.proceed) {
                  window.alert("Configuration annulée. Aucun changement n'a été appliqué.");
                  submitButton.disabled = false;
                  return;
                }
                var cleanupPromise = decision.shouldCleanup
                  ? deleteBigQueryTablesForForm(formulaireObj)
                  : Promise.resolve();
                cleanupPromise
                  .then(function() {
                    proceedWithFormSave(formulaireObj);
                  })
                  .catch(function(errorMessage) {
                    if (errorMessage) {
                      window.alert(errorMessage);
                    } else {
                      window.alert("Suppression BigQuery impossible. Configuration interrompue.");
                    }
                    submitButton.disabled = false;
                  });
              })
              .catch(function(errorMessage) {
                if (errorMessage) {
                  window.alert(errorMessage);
                }
                submitButton.disabled = false;
              });
          })
          .withFailureHandler(function(error) {
            console.error("Erreur lors de la vérification BigQuery:", error);
            window.alert("Impossible de vérifier la présence de la table BigQuery. Réessayez plus tard.");
            submitButton.disabled = false;
          })
          .describeBigQueryTableStatus({
            tableName: formulaireObj.tableName,
            formId: formulaireObj.id,
            formName: formulaireObj.nom
          });
      }

      function evaluateTableStatus(status) {
        return new Promise(function(resolve, reject) {
          if (!status) {
            reject("Vérification BigQuery indisponible. Configuration interrompue.");
            return;
          }
          if (status.error && !status.checkSkipped) {
            reject("Erreur lors de la vérification BigQuery : " + status.error);
            return;
          }
          if (status.checkSkipped) {
            console.warn("Vérification BigQuery non effectuée :", status.skipReason || "motif inconnu");
            resolve({ proceed: true, shouldCleanup: false, status: status });
            return;
          }
          if (status.exists) {
            showExistingTableModal(status).then(function(confirmation) {
              resolve({
                proceed: Boolean(confirmation),
                shouldCleanup: Boolean(confirmation),
                status: status
              });
            });
            return;
          }
          resolve({ proceed: true, shouldCleanup: false, status: status });
        });
      }

      function showExistingTableModal(status) {
        if (!existingTableModalInstance || !existingTableLabel || !existingTableConfirmBtn) {
          const fallbackMessage =
            `La table BigQuery « ${status.fullTableId || status.tableName} » existe déjà.\n` +
            "Continuer va remplacer la configuration précédente et effacer la table actuelle.\n" +
            "OK : réutiliser cette table • Annuler : interrompre l'enregistrement.";
          const decision = window.confirm(fallbackMessage);
          return Promise.resolve(decision);
        }

        existingTableLabel.textContent = status.fullTableId || status.tableName;
        if (existingTableDataset) {
          const project = status.projectId || 'Projet non défini';
          const dataset = status.datasetId || 'Dataset non défini';
          existingTableDataset.textContent = `Projet : ${project} • Dataset : ${dataset}`;
        }

        return new Promise(function(resolve) {
          pendingTableModalResolver = resolve;
          existingTableModalInstance.show();
        });
      }

      function deleteBigQueryTablesForForm(formulaireObj) {
        return new Promise(function(resolve, reject) {
          google.script.run
            .withSuccessHandler(function(response) {
              console.log("Suppressions BigQuery effectuées:", response);
              resolve(response);
            })
            .withFailureHandler(function(error) {
              console.error("Suppression BigQuery impossible:", error);
              reject(
                error && error.message
                  ? "Suppression BigQuery impossible : " + error.message
                  : "Suppression BigQuery impossible. Consultez les journaux."
              );
            })
            .deleteExistingBigQueryTables({
              id: formulaireObj.id,
              nom: formulaireObj.nom,
              tableName: formulaireObj.tableName,
              alias: formulaireObj.alias
            });
        });
      }

      function resolveExistingTableModal(decision) {
        if (pendingTableModalResolver) {
          var resolver = pendingTableModalResolver;
          pendingTableModalResolver = null;
          resolver(Boolean(decision));
        }
      }

      if (existingTableConfirmBtn) {
        existingTableConfirmBtn.addEventListener('click', function() {
          if (existingTableModalInstance) {
            existingTableModalInstance.hide();
          }
          resolveExistingTableModal(true);
        });
      }

      if (existingTableCancelBtn) {
        existingTableCancelBtn.addEventListener('click', function() {
          resolveExistingTableModal(false);
        });
      }

      if (existingTableModalEl) {
        existingTableModalEl.addEventListener('hidden.bs.modal', function() {
          resolveExistingTableModal(false);
        });
      }

      function proceedWithFormSave(formulaireObj) {
        google.script.run
          .withSuccessHandler(function() {
            google.script.run
              .withSuccessHandler(function() {
                google.script.host.close();
              })
              .withFailureHandler(function(error) {
                console.error("Erreur lors de l'ouverture du sélecteur de fréquence:", error);
                window.alert("Impossible d'ouvrir la configuration de la mise à jour automatique. Vous pouvez la lancer depuis le menu 'Configuration Kizeo'.");
                google.script.host.close();
              })
              .openTriggerFrequencyDialog();
          })
          .withFailureHandler(function(error) {
            console.error("Erreur:", error);
            const message = (error && error.message) || '';
            if (
              message.indexOf('EXECUTION_EN_COURS') !== -1 ||
              message.toLowerCase().indexOf('mise à jour est déjà en cours') !== -1
            ) {
              window.alert("Une mise à jour est déjà en cours. Patientez avant de relancer.");
            } else {
              window.alert("Impossible de finaliser l'enregistrement. Consultez les journaux pour plus de détails.");
            }
            submitButton.disabled = false;
          })
          .enregistrementUI(formulaireObj);
      }
      function slugifyIdentifier(value) {
        if (!value) return '';
        return value
          .toString()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-zA-Z0-9_]/g, '_')
          .replace(/^_+/, '')
          .replace(/_+$/g, '')
          .toLowerCase();
      }

      function sanitizeTablePart(source, fallback) {
        if (source === null || source === undefined) return fallback;
        const trimmed = String(source).trim();
        if (!trimmed) return fallback;
        const slug = slugifyIdentifier(trimmed);
        if (!slug) return fallback;
        if (slug === 'field' && trimmed.toLowerCase() !== 'field') {
          return fallback;
        }
        return slug;
      }

      function joinTableParts(parts) {
        return parts.filter((part) => part && part.length).join(BQ_TABLE_PART_SEPARATOR);
      }

      function buildDefaultTableName(formId, formName) {
        const idPart = sanitizeTablePart(formId, 'form');
        const namePart = sanitizeTablePart(formName, 'sheet');
        return joinTableParts([idPart, namePart]);
      }

      function normalizeTableName(formId, formName, rawValue) {
        const idPart = sanitizeTablePart(formId, 'form');
        const fallbackNamePart = sanitizeTablePart(formName, 'sheet');
        const trimmed = rawValue ? String(rawValue).trim() : '';
        if (!trimmed) {
          return joinTableParts([idPart, fallbackNamePart]);
        }

        const normalizedInput = slugifyIdentifier(trimmed);
        if (!normalizedInput) {
          return joinTableParts([idPart, fallbackNamePart]);
        }

        let aliasCandidate = normalizedInput;
        if (normalizedInput.includes(BQ_TABLE_PART_SEPARATOR)) {
          const segments = normalizedInput.split(BQ_TABLE_PART_SEPARATOR).filter(Boolean);
          if (!segments.length) {
            aliasCandidate = fallbackNamePart;
          } else if (segments[0] === idPart && segments.length > 1) {
            aliasCandidate = segments.slice(1).join(BQ_TABLE_PART_SEPARATOR);
          } else {
            aliasCandidate = segments[segments.length - 1];
          }
        }

        const aliasPart = sanitizeTablePart(aliasCandidate, fallbackNamePart);
        return joinTableParts([idPart, aliasPart]);
      }

      function extractAliasPart(formId, tableName) {
        if (!tableName) return '';
        const idPart = sanitizeTablePart(formId, 'form');
        const segments = tableName.split(BQ_TABLE_PART_SEPARATOR);
        if (segments.length <= 1) {
          return tableName;
        }
        if (segments[0] === idPart) {
          return segments.slice(1).join(BQ_TABLE_PART_SEPARATOR);
        }
        return segments[segments.length - 1];
      }
    </script>
  </body>
</html>

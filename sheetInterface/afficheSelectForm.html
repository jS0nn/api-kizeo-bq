<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <title>KIZEOFORM</title>
  </head>
  <body>

    <div class="container mt-3">

      <h1 class="mt-3 shadow p-3 mb-5 bg-white rounded text-center text-primary">Selectionner un formulaire : </h1>
     <div class="d-none" id="divForm">
        <label for="selectForm" class="form-label">Formulaires :</label>
        <div class="form-text">Choisir le formulaire à traiter</div>
        <div class="input-group">
            <div class="input-field">
                <select type="text" class="select2Class" id="selectForm" name="selectForm" required>  
                </select>
            </div>
        </div>
       <br>
        <form id="formulaireVariables"> 
          <div id="divCheckboxes"></div>
          <div class="mb-3">
            <label for="aliasName" class="form-label">Alias BigQuery</label>
            <input type="text" class="form-control" id="aliasName" name="aliasName" maxlength="64" placeholder="ex. inspections_brevets" required>
            <div class="form-text">Nom lisible utilisé pour nommer les tables BigQuery.</div>
          </div>
          <div class="d-flex justify-content-center mb-4">
            <button type="submit" id="boutonEnvoiFormulaireVariables">Ajouter à la configuration</button>                
          </div>  
        </form>  
      </div>
      

      <div class="d-flex justify-content-center mt-5">
        <div class="d-none" role="status" id="chargement">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </div>
    

    <!-- Optional JavaScript-->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function(event) { 
        //équivalent du document ready jquery
        document.getElementById("chargement").className = "spinner-border text-primary";
        
        google.script.run.withSuccessHandler(creeListeForm).chargelisteFormulaires();
      });


      var selectForm = document.getElementById('selectForm');

      selectForm.addEventListener('change', function() {
        var index = selectForm.selectedIndex;
        var valeur = selectForm.value;
        // Rapporter cette donnée au <p>
        console.log("Nv Formulaire selectionné n°: " + index + " - ID: " + valeur);
        document.getElementById("boutonEnvoiFormulaireVariables").className = "btn btn-primary btn-lg";
        const aliasInput = document.getElementById('aliasName');
        if (index > 0) {
          const formName = selectForm.options[index].text;
          aliasInput.value = slugify(formName).slice(0, 64);
        } else {
          aliasInput.value = '';
        }
      });

      function creeListeForm(listeForm) {
        console.table(listeForm);

        var sel = document.getElementById("selectForm");
        var opt = document.createElement("option");
        opt.value = "";
        opt.text = "Formulaires";
        sel.add(opt, null);  //ajoute l'option à la fin du select

        for(let i=0; i<listeForm.length; i++){
          console.log(listeForm[i].id);
          var opt = document.createElement("option");
          opt.value = listeForm[i].id;
          opt.text = listeForm[i].name;
          sel.add(opt, null);  //ajoute l'option à la fin du select
        }
        
        document.getElementById("selectForm").options[0].disabled = true;
        document.getElementById("chargement").className = "d-none";
        document.getElementById("divForm").className = "d-block shadow-sm p-3 mb-5 bg-white";
        $('.select2Class').select2();
      }

      // Gestion du formulaire avec preventDefault pour éviter les soumissions multiples
      document.getElementById("formulaireVariables").addEventListener("submit", function(event) {
        event.preventDefault(); // Empêche la soumission standard du formulaire
        handleFormSubmitVar();
      });

      //Envoie les données dans le GS pour stockage en Sheet
      function handleFormSubmitVar() {
        console.log("handleFormSubmit Formulaire");
        var selectForm = document.getElementById('selectForm');
        var formulaire = selectForm.options[selectForm.selectedIndex].text;
        var formulaireID = selectForm.options[selectForm.selectedIndex].value;
        console.log(formulaire + " / " + formulaireID);
        
        const aliasInput = document.getElementById('aliasName');
        const aliasName = aliasInput.value.trim();

        let hasError = false;
        if (!aliasName) {
          aliasInput.classList.add('is-invalid');
          if (!hasError) aliasInput.focus();
          hasError = true;
        } else if (aliasName.length > 64) {
          aliasInput.classList.add('is-invalid');
          if (!hasError) aliasInput.focus();
          hasError = true;
        } else {
          aliasInput.classList.remove('is-invalid');
        }

        if (hasError) {
          return;
        }

        // Désactiver le bouton pour éviter les clics multiples
        document.getElementById("boutonEnvoiFormulaireVariables").disabled = true;
        
        var formulaireObj = {id: formulaireID, nom: formulaire, alias: aliasName};
        google.script.run
          .withSuccessHandler(function() {
            google.script.host.close();
          })
          .withFailureHandler(function(error) {
            console.error("Erreur:", error);
            document.getElementById("boutonEnvoiFormulaireVariables").disabled = false;
          })
          .enregistrementUI(formulaireObj);
      }
      function slugify(value) {
        if (!value) return '';
        return value
          .toString()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .replace(/[^a-zA-Z0-9]+/g, '_')
          .replace(/^_+|_+$/g, '')
          .toLowerCase();
      }
    </script>
  </body>
</html>
